name: Build TOX-HUD-和平 (.tipa / .deb via Xcode)

on:
  push:
    tags:
      - "v*.*.*"
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.1'
  PROJECT_NAME: 'TOX-HUD-和平'

jobs:
  build:
    runs-on: macos-13

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ⚙️ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: 🧰 Install dependencies
        run: |
          HOMEBREW_NO_AUTO_UPDATE=1 brew install ldid dpkg zip
          sudo gem install xcpretty
          echo "✅ Installed dependencies (ldid, dpkg, zip, xcpretty)"

      - name: 🔐 Make scripts executable
        run: |
          chmod +x ./build.sh || true
          chmod +x ./gen-control.sh || true
          echo "✅ build.sh and gen-control.sh are ready to run"

      - name: 🧱 Get version info
        id: version
        run: |
          VERSION_TAG=$(git describe --tags --always || echo "v1.0.0")
          VERSION=${VERSION_TAG#v}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "📦 Detected version: ${VERSION_TAG}"

      - name: 🚀 Build .tipa using Xcode
        run: |
          if [ -f "build.sh" ]; then
            echo "🛠 Building ${{ env.PROJECT_NAME }}..."
            # ✅ إصلاح مسار ldid داخل build.sh
            sed -i '' 's|/Users/zaizai/Desktop/ldid|/usr/local/bin/ldid|g' build.sh
            chmod +x build.sh

            # ✅ ضمان وجود مجلد packages لتخزين المخرجات
            mkdir -p packages

            # ✅ تنفيذ عملية البناء
            ./build.sh v${{ env.VERSION }}

            echo "✅ Build completed successfully."
          else
            echo "❌ build.sh not found!"
            exit 1
          fi

      - name: 🧾 Fix DEBIAN permissions (optional)
        run: |
          if [ -d "layout/DEBIAN" ]; then
            chmod 755 layout/DEBIAN/* || true
            echo "✅ Fixed DEBIAN script permissions"
          else
            echo "⚠️ No DEBIAN folder found, skipping."
          fi

      - name: 🗂️ Rename output with version
        run: |
          mkdir -p packages
          cd packages
          if ls ../packages/*.tipa >/dev/null 2>&1; then
            for f in ../packages/*.tipa; do
              base=$(basename "$f" .tipa)
              mv "$f" "${base}_v${{ env.VERSION }}.tipa"
            done
            echo "✅ Renamed .tipa files with version suffix"
          fi

      - name: ☁️ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}_Packages
          path: |
            packages/*.tipa
            packages/*.deb

      - name: 🚀 Upload GitHub Release (if tagged)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            🎯 ${{ env.PROJECT_NAME }} build v${{ env.VERSION }} completed successfully!
            ✅ Built via Xcode + TrollStore workflow.
          generate_release_notes: true
          files: |
            packages/*.tipa
            packages/*.deb

      - name: 📋 Build Summary
        if: always()
        run: |
          echo "----------------------------------------"
          echo "📦 Build Summary for ${{ env.PROJECT_NAME }}"
          echo "----------------------------------------"
          cd packages || exit 0
          if ls *.tipa >/dev/null 2>&1; then
            echo "✅ TrollStore build (.tipa) found:"
            ls -lh *.tipa
          else
            echo "⚠️ No .tipa found."
          fi
          if ls *.deb >/dev/null 2>&1; then
            echo "✅ Jailbreak build (.deb) found:"
            ls -lh *.deb
          else
            echo "⚠️ No .deb found."
          fi
          echo "----------------------------------------"
          echo "🏁 Build completed at $(date)"
