name: Build TOX-HUD-å’Œå¹³ (.tipa / .deb via Xcode)

on:
  push:
    tags:
      - "v*.*.*"
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  XCODE_VERSION: "15.1"
  PROJECT_NAME: "TOX-HUD-å’Œå¹³"

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 30

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: âš™ï¸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: ğŸ§° Install dependencies
        run: |
          HOMEBREW_NO_AUTO_UPDATE=1 brew install ldid dpkg zip
          sudo gem install xcpretty
          echo "âœ… Installed dependencies (ldid, dpkg, zip, xcpretty)"

      - name: ğŸ” Make scripts executable
        run: |
          chmod +x ./build.sh || true
          chmod +x ./gen-control.sh || true
          echo "âœ… build.sh and gen-control.sh are ready to run"

      - name: ğŸ§± Get version info
        id: version
        run: |
          VERSION_TAG=$(git describe --tags --always || echo "v1.0.0")
          VERSION=${VERSION_TAG#v}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "ğŸ“¦ Detected version: ${VERSION_TAG}"

      - name: ğŸ” Detect Xcode Scheme Automatically
        id: detect_scheme
        run: |
          echo "ğŸ” Detecting scheme from project: '${{ env.PROJECT_NAME }}.xcodeproj'"
          SCHEME=$(xcodebuild -list -project "${{ env.PROJECT_NAME }}.xcodeproj" | awk '/Schemes:/ {getline; print $1; exit}')
          if [ -z "$SCHEME" ]; then
            echo "âŒ No scheme found in Xcode project!"
            echo "ğŸ’¡ Make sure your .xcodeproj contains at least one shared scheme."
            exit 1
          fi
          echo "âœ… Detected Scheme: $SCHEME"
          echo "SCHEME_NAME=$SCHEME" >> $GITHUB_ENV

      - name: ğŸš€ Build .tipa using Xcode
        run: |
          echo "ğŸ›  Building '${{ env.PROJECT_NAME }}' (scheme: ${{ env.SCHEME_NAME }})..."

          # âœ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø³Ø§Ø± ldid Ø¯Ø§Ø®Ù„ build.sh (ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù…Ø°ÙƒÙˆØ± Ø¨Ø´ÙƒÙ„ Ø«Ø§Ø¨Øª)
          if grep -q "/Users/zaizai/Desktop/ldid" build.sh; then
            sed -i '' "s|/Users/zaizai/Desktop/ldid|/usr/local/bin/ldid|g" build.sh
          fi

          # âœ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù€ scheme Ø¯Ø§Ø®Ù„ build.sh
          sed -i '' "s|SCHEME_NAME=.*|SCHEME_NAME='${{ env.SCHEME_NAME }}'|g" build.sh

          chmod +x build.sh
          mkdir -p packages

          ./build.sh v${{ env.VERSION }}
          echo "âœ… Build completed successfully."

      - name: ğŸ§¾ Fix DEBIAN permissions (optional)
        run: |
          if [ -d "layout/DEBIAN" ]; then
            chmod 755 layout/DEBIAN/* || true
            echo "âœ… Fixed DEBIAN script permissions"
          else
            echo "âš ï¸ No DEBIAN folder found, skipping."
          fi

      - name: â˜ï¸ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.PROJECT_NAME }}_Packages"
          path: |
            packages/*.tipa
            packages/*.deb
          if-no-files-found: warn

      - name: ğŸš€ Upload GitHub Release (if tagged)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: "Release v${{ env.VERSION }} â€” TOX-HUD-å’Œå¹³"
          body: |
            ğŸ¯ **${{ env.PROJECT_NAME }} v${{ env.VERSION }}**
            âœ… Built automatically via GitHub Actions (Xcode 15.1)
            - Includes TrollStore `.tipa` build
            - Includes Jailbreak `.deb` (if available)
          generate_release_notes: true
          files: |
            packages/*.tipa
            packages/*.deb

      - name: ğŸ“‹ Build Summary
        if: always()
        run: |
          echo "----------------------------------------"
          echo "ğŸ“¦ Build Summary for '${{ env.PROJECT_NAME }}'"
          echo "----------------------------------------"
          cd packages || exit 0
          if ls *.tipa >/dev/null 2>&1; then
            echo "âœ… TrollStore build (.tipa) found:"
            ls -lh *.tipa
          else
            echo "âš ï¸ No .tipa found."
          fi
          if ls *.deb >/dev/null 2>&1; then
            echo "âœ… Jailbreak build (.deb) found:"
            ls -lh *.deb
          else
            echo "âš ï¸ No .deb found."
          fi
          echo "----------------------------------------"
          echo "ğŸ Build completed at $(date)"
